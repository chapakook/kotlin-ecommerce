# 시퀀스 다이어그램

## 도메인
- [잔액조회](#잔액조회)
- [잔액충전](#잔액충전)
- [상품조회](#상품조회)
- [선착순 쿠폰발급](#선착순-쿠폰발급)
- [주문/결제](#주문결제)
- [상위 상품 조회](#상위-상품-조회)

<br>

### 잔액조회
```mermaid
sequenceDiagram
    사용자 ->> 잔액조회 : 잔액조회 요청
    activate 사용자
    activate 잔액조회
    잔액조회 ->> 유저 : 유저조회
    activate 유저
    activate 유저
    deactivate 잔액조회
    alt 유저 없음
        유저 -->> 사용자 : "유저없음" 오류 리턴
        deactivate 유저
    else 유저 있음
        유저 ->> 포인트 : 잔액조회
        deactivate 유저
        activate 포인트
    end
    포인트 -->> 사용자 : "잔액" 리턴
    deactivate 포인트
    deactivate 사용자
```
<br>

### 잔액충전
```mermaid
sequenceDiagram
    사용자 ->> 잔액충전 : 잔액충전 요청
    activate 사용자
    activate 잔액충전
    잔액충전 ->> 유저 : 유저조회
    deactivate 잔액충전
    activate 유저
    activate 유저
    alt 유저 없음
        유저 -->> 사용자 : "유저없음" 오류 리턴
        deactivate 유저
    else 유저 있음
        유저 ->> 포인트 : 잔액 충전
        deactivate 유저
        activate 포인트
        activate 포인트
    end
    alt 충전요천 포인트 이상
        포인트 -->> 사용자 : "충전포인트 이상" 오류 리턴
        deactivate 포인트
    else 충전요청 포인트 정상
        포인트 ->> 포인트 : 포인트 충전
        포인트 -->> 사용자 : "잔액" 리턴
    end
    deactivate 포인트
    deactivate 사용자
```
<br>

### 상품조회
```mermaid
sequenceDiagram
    사용자 ->> 상품조회 : 상품조회 요청
    activate 사용자
    activate 상품조회
    상품조회 ->> 상품 : 상품조회
    deactivate 상품조회
    activate 상품
    상품 -->> 사용자 : "조회된 상품" 리턴
    deactivate 상품
    deactivate 사용자
```

<br>

### 선착순 쿠폰발급
```mermaid
sequenceDiagram
    사용자 ->> +쿠폰이벤트: 쿠폰발급 요청
    쿠폰이벤트 ->> +쿠폰: 쿠폰재고확인
    쿠폰 -->> -쿠폰이벤트: 쿠폰 재고 반환
    alt 재고없음
        쿠폰이벤트 -->> 사용자: 쿠폰재고없음 반환
    else 재고있음
        쿠폰이벤트 ->> +쿠폰: 쿠폰발급
        쿠폰 ->> 쿠폰: 쿠폰재고차감
        쿠폰 -->> -쿠폰이벤트: 쿠폰 반환
        쿠폰이벤트 -->> -사용자: 쿠폰반환
    end
```
<br>

### 주문/결제
주문/결제
```mermaid
sequenceDiagram
    사용자 ->> +주문: 주문요청
    주문 ->> +재고: 재고조회
    재고 -->> -주문: 재고 반환
    alt 재고없음
        주문 -->> 사용자: 재고없음 반환
    else 재고있음
        주문 ->> +재고: 재고차감 요청
        재고 ->> 재고: 재고차감
        재고 -->> -주문: 재고 반환
        주문 ->> +상품: 상품조회
        상품 -->> -주문: 상품 반환
        주문 ->> 주문: 주문생성
        주문 ->> +쿠폰: 쿠폰조회
        쿠폰 -->> -주문: 쿠폰 반환
        opt 쿠폰사용가능
            주문 ->> +쿠폰: 쿠폰사용 요청
            쿠폰 ->> 쿠폰: 쿠폰사용
            쿠폰 -->> -주문: 쿠폰 반환
        end
        주문 ->> +포인트: 포인트 조회
        포인트 -->> -주문: 포인트 반환
        alt 포인트 없음
            주문 -->> 주문: 주문취소
            주문 -->> +재고: 재고롤백요청
            재고 -->> 재고: 재고롤백
            재고 --> -주문: 재고 리턴
            주문 -->> 사용자: 주문실패 반환
        else 포인트 있음
            주문 ->> +포인트: 포인트차감 요청(쿠폰이 있는 경우 계산해서 차감)
            포인트 ->> 포인트: 포인트차감
            포인트 -->> -주문: 포인트 반환
            주문 ->> +결제: 결제저장 요청
            결제 ->> 결제: 결제저장
            결제 -->> -주문: 결제 반환
        end
        주문 -->> -사용자: 주문완료 반환
    end
```

<br>

### 상위 상품 조회
```mermaid
sequenceDiagram
    사용자 ->> 상위상품조회 : 상위상품조회 요청
    activate 사용자
    activate 상위상품조회
    상위상품조회 ->> 집계데이터 : 조회
    deactivate 상위상품조회
    activate 집계데이터
    alt 집계데이터 >= 5
        집계데이터 -->> 사용자 : "상위상품" 5개 리턴
        activate 집계데이터
        deactivate 집계데이터
    else 5 > 집계데이터 > 0
        집계데이터 -->> 사용자 : "상위상품" 리턴
        activate 집계데이터
        deactivate 집계데이터
    else 집계데이터 >= 0
        집계데이터 -->> 사용자 : "없음" 리턴
        activate 집계데이터
        deactivate 집계데이터
    end
    deactivate 집계데이터
    deactivate 사용자
```