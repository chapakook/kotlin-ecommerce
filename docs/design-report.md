## ë°°ê²½
ì‚¬ìš©ì ìˆ˜ê°€ ì¦ê°€í•¨ì— ë”°ë¼ ì¸ê¸° ìƒí’ˆ ì¡°íšŒì™€ ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ê¸°ëŠ¥ì—ì„œ ì„±ëŠ¥ ì €í•˜ í˜„ìƒì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.
ê¸°ì¡´ì—ëŠ” ë‹¨ìˆœ RDB ê¸°ë°˜ì˜ ì •ë ¬ ë° ë°œê¸‰ ë¡œì§ìœ¼ë¡œ ì²˜ë¦¬í–ˆì§€ë§Œ, íŠ¸ë˜í”½ ì¦ê°€ì— ë”°ë¥¸ ë³‘ëª©ê³¼ ë™ì‹œì„± ì´ìŠˆê°€ ë°˜ë³µë˜ê³  ìˆìŠµë‹ˆë‹¤.
ì´ì— ë”°ë¼ ê³ ì„±ëŠ¥ ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•œ Redis ê¸°ë°˜ êµ¬ì¡° ë„ì…ì„ í†µí•´ ì‹œìŠ¤í…œì˜ ì‘ë‹µì„±ê³¼ ì•ˆì •ì„±ì„ ê°œì„ í•˜ê³ ì í•©ë‹ˆë‹¤.

## ë¶„ì„ ë° ë¬¸ì œì 
### ì¸ê¸°ìƒí’ˆì¡°íšŒ
ì‹¤ì‹œê°„ íŠ¸ë˜í”½ì´ ì§‘ì¤‘ë˜ë©° ì¡°íšŒìˆ˜ ìˆœ ì •ë ¬ ì¿¼ë¦¬ë¡œ ì¸í•´ DB ë¶€í•˜ ì‹¬í™”
ë‹¤ì¤‘ join, ì •ë ¬ ì—°ì‚°ì´ ì¦ì•„ ì‘ë‹µ ì§€ì—° ë°œìƒ
ì •ë ¬ ê¸°ì¤€ ë°ì´í„°ê°€ DBì— ì‹¤ì‹œê°„ ë°˜ì˜ë˜ì§€ ì•Šì•„ ë­í‚¹ ì •í™•ë„ ì €í•˜ ê°€ëŠ¥

### ì„ ì°©ìˆœì¿ í°ë°œê¸‰
ì‚¬ìš©ìê°€ ë™ì‹œì— ìš”ì²­í•  ê²½ìš° DB ë½ ê²½í•©ì´ ë°œìƒí•˜ì—¬ ì‘ë‹µ ì§€ì—° ë˜ëŠ” ì‹¤íŒ¨ ê°€ëŠ¥ì„±
ì¤‘ë³µ ë°œê¸‰, race condition ë¬¸ì œ ë°œìƒ
ì¿ í° ìˆ˜ëŸ‰ ì œí•œ ë¡œì§ì˜ ì¼ê´€ì„± ë³´ì¥ ì–´ë ¤ì›€

## ì„¤ê³„
### ì¸ê¸°ìƒí’ˆì¡°íšŒ
ì¸ê¸° ìƒí’ˆ ì¡°íšŒëŠ” ì‚¬ìš©ì íŠ¸ë˜í”½ì´ ëª°ë¦¬ëŠ” í•µì‹¬ ê¸°ëŠ¥ìœ¼ë¡œ, ì‹¤ì‹œê°„ ì¡°íšŒìˆ˜ ê¸°ë°˜ ì •ë ¬ì´ í•„ìš”í•©ë‹ˆë‹¤.
ê¸°ì¡´ RDB ê¸°ë°˜ ì •ë ¬ ì¿¼ë¦¬ì˜ ë¶€í•˜ë¥¼ ì¤„ì´ê³ , ë¹ ë¥¸ ì‘ë‹µì„ ë³´ì¥í•˜ê¸° ìœ„í•´ Redis `ZSet`ì„ í™œìš©í•œ ìºì‹± êµ¬ì¡°ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.
- í˜„ì¬ ì§‘ê³„ëŠ” ìƒí’ˆíŒë§¤ ìˆ˜ëŸ‰ìœ¼ë¡œë§Œ ì§‘ê³„ë¥¼ ì§„í–‰ì¤‘ì´ë©°, ìƒí’ˆì„ êµ¬ë§¤ ì™„ë£Œìˆ˜ ì§‘ê³„ ìˆ˜ëŸ‰ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ì„¤ê³„ë¥¼ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.
- ì´ë ‡ê²Œ ì§‘ê³„ëœ ë°ì´í„°ëŠ” `ZUNION`ì„ í†µí•´ ì¸ê¸°ìƒí’ˆì˜ ê¸°ì¤€ì¸ 3ì¼ ì¹˜ì˜ í•©ì§‘í•©ì„ êµ¬í•œ í›„ ì‘ë‹µí•©ë‹ˆë‹¤
- `TTL`ì€ ì§‘ê³„ë°ì´í„°ëŠ” 3ì¼ì¹˜ë§Œ í•„ìš”í•¨ìœ¼ë¡œ `3d`ë¡œ êµ¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.
- ì¸ê¸°ìƒí’ˆì˜ ê²½ìš° íœ˜ë°œì„± ë°ì´í„°ë¼ê³  íŒë‹¨. ì˜ì†í™”ë¥¼ ì§„í•´í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

### ì¸í„°í˜ì´ìŠ¤ì˜ í™œìš©
```kotlin
interface RankingTarget {
    val productId: Long
    val quantity: Int
}
```
ì¸í„°í˜ì´ìŠ¤ë¥¼ í™œìš©í•˜ì—¬, ì¸ê¸°ìƒí’ˆìš”ê±´ì„ êµ¬ì²´í™”í•˜ì—¬ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

### ë­í‚¹ì¦ê°€ -> AOPë¡œ êµ¬ì„±
```kotlin
@Target(AnnotationTarget.FUNCTION)
@Retention(AnnotationRetention.RUNTIME)
annotation class IncreasesProductRanking

@Aspect
@Component
class IncreasesProductRankingAspect(
    private val productRankRepository: ProductRankingRepository
) {
    @AfterReturning("@annotation(kr.hhplus.be.server.support.annotation.IncreasesProductRanking)")
    fun afterReturning(joinPoint: JoinPoint) {
        if (!TransactionSynchronizationManager.isSynchronizationActive()) return
        TransactionSynchronizationManager.registerSynchronization(object : TransactionSynchronization {
            override fun afterCommit() {
                joinPoint.args
                    .filterIsInstance<RankingTarget>()
                    .forEach {
                        productRankRepository.increaseProductRank(
                            productId = it.productId,
                            scoreDelta = it.quantity.toDouble()
                        )
                    }
            }
        })
    }
}
```
ì»¤ìŠ¤í…€ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ ê¸°ì¡´ë¡œì§ì— ì˜í–¥ì—†ì´ ë­í‚¹ì— ì˜í–¥ë„ê°€ ìˆëŠ” ë°ì´í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

### ì„ ì°©ìˆœì¿ í°ë°œê¸‰
ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ì€ ì‚¬ìš©ì ìš”ì²­ì´ í­ì£¼í•  ìˆ˜ ìˆëŠ” ì´ë²¤íŠ¸ì„± ê¸°ëŠ¥ì…ë‹ˆë‹¤. 
ë°œê¸‰ ìˆœì„œë¥¼ ë³´ì¥í•˜ë©´ì„œë„ ì„±ëŠ¥ ì €í•˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ëŒ€ê¸°ì—´ì€ Redis `ZSet`ìœ¼ë¡œ êµ¬ì„±í•˜ê³ , ì‹¤ì œ ë°œê¸‰ì€ ìŠ¤ì¼€ì¤„ëŸ¬ì— ì˜í•´ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
- ì‹ ì†í•œ ìš”ì²­ ì²˜ë¦¬ë¥¼ ìœ„í•´ `ì¿ í°ë°œê¸‰ìš”ì²­`ì´ ë“¤ì–´ì˜¤ë©´ `Queue`ì— ì‘ì—…ì„ ì ì œí•©ë‹ˆë‹¤.
- `ZSet`ì„ ì´ìš©, ì¤‘ë³µì²˜ë¦¬ë¥¼ ë°©ì§€í–ˆìŠµë‹ˆë‹¤. 
- `ì¿ í°ë°œê¸‰ì²˜ë¦¬`ì˜ ê²½ìš° ì¼ì •ì£¼ê¸°ë¡œ ë°œê¸‰íë¥¼ ìŠ¤ì¼€ì¤„ë§í•˜ë©° ì¿ í° ë°œê¸‰ì„ ì§„í–‰í•©ë‹ˆë‹¤.
- `ì¿ í°ë°œê¸‰ì²˜ë¦¬`ì‹œ DBì— ì˜ì†í™”ë„ ê°™ì´ ì§„í–‰í•©ë‹ˆë‹¤.


### Redis Key ì„¤ê³„
```kotlin
enum class RedisPrefix(val prefix: String) {
    CACHE_PRODUCTS("products"),

    CACHE_RANK("rank"),
    CACHE_PRODUCTS_RANK("${CACHE_RANK.prefix}:${CACHE_PRODUCTS.prefix}"),
    CACHE_PRODUCT_RANK_DAILY("${CACHE_PRODUCTS_RANK.prefix}:daily"),

    CACHE_QUEUE("queue"),
    CACHE_COUPONS("coupons"),
    CACHE_COUPON_EVENTS("coupon-events"),
    CACHE_QUEUE_COUPON_EVENTS("${CACHE_QUEUE.prefix}:${CACHE_COUPON_EVENTS.prefix}"),
}
```
enum classë¥¼ í™œìš©, í•œê³³ì—ì„œ ê´€ë¦¬í•˜ì—¬ í‚¤ê°’ì„ ìœ ì‹¤ ë°©ì§€ë¥¼ ì˜€ìŠµë‹ˆë‹¤.

## Redisì˜ ë¶ˆì•ˆì •ì„±ì— ëŒ€í•œ ê³ ë ¤ ì‚¬í•­
í˜„ì¬ì˜ êµ¬ì¡°ëŠ” redisì— ë§ì´ ì˜ì¡´í•˜ê³  ìˆëŠ” êµ¬ì¡°ì´ë©°, redis ì¥ì• ì‹œ ì‹œìŠ¤í…œ ì¥ì• ë¡œ ì•„ì£¼ í° ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆì„ ê²ƒ ìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.

ë‹¨ì¼ ì¥ì• ì (SPOF): Redisê°€ ë‹¨ì¼ ë…¸ë“œë¡œ ìš´ì˜ë  ê²½ìš° ì¥ì•  ë°œìƒ ì‹œ ì „ì²´ ì¿ í° ë°œê¸‰ì´ë‚˜ ì¸ê¸° ìƒí’ˆ ì¡°íšŒ ê¸°ëŠ¥ì´ ë©ˆì¶œ ìˆ˜ ìˆìŒ

ë©”ëª¨ë¦¬ ê¸°ë°˜ ì €ì¥ì†Œì˜ íŠ¹ì„±ìƒ íœ˜ë°œì„± ìœ„í—˜ ì¡´ì¬: ì˜ì†ì„± ì„¤ì • ì—†ì´ ì‚¬ìš© ì‹œ ì¥ì•  ë³µêµ¬ í›„ ë°ì´í„° ìœ ì‹¤ ê°€ëŠ¥
ë„¤íŠ¸ì›Œí¬ ë¶„ë¦¬ ë˜ëŠ” í´ëŸ¬ìŠ¤í„° íŒŒí¸í™”: í´ëŸ¬ìŠ¤í„° ëª¨ë“œì—ì„œ ë¶„ì‚° ë…¸ë“œ ê°„ ë„¤íŠ¸ì›Œí¬ ì´ìŠˆ ë°œìƒ ì‹œ ì¼ë¶€ keyì— ì ‘ê·¼ ë¶ˆê°€

Failover ì‹œ ì¼ê´€ì„± ë¬¸ì œ: Sentinel ë˜ëŠ” Cluster ê¸°ë°˜ Redis ì‚¬ìš© ì‹œ ìë™ ì¥ì•  ì¡°ì¹˜ ì¤‘ ë°ì´í„° ì •í•©ì„± ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ
ê³¼ë¶€í•˜ ì‹œ ì„±ëŠ¥ ì €í•˜: TTL ì„¤ì • ì—†ì´ ZSetì— ê³„ì† ìŒ“ì¼ ê²½ìš° ë©”ëª¨ë¦¬ ë¶€ì¡± ë˜ëŠ” ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥

> ğŸ’¡ ì´ëŸ¬í•œ ìœ„í—˜ ìš”ì†Œë¥¼ ì™„í™”í•˜ê¸° ìœ„í•´, ì¥ì•  ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤, Redis ìš´ì˜ ì„¤ì • ìµœì í™”, ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ . ì²´ê³„ ë§ˆë ¨ì´ í•„ìš”í•©ë‹ˆë‹¤.

## ê²°ë¡ 
Redis ê¸°ë°˜ì˜ êµ¬ì¡° ê°œì„ ì„ í†µí•´ ê¸°ì¡´ RDB ì¤‘ì‹¬ì˜ ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ë° ì¸ê¸° ìƒí’ˆ ì¡°íšŒ ì²˜ë¦¬ ë°©ì‹ì—ì„œ ë°œìƒí•˜ë˜ ì„±ëŠ¥ ë³‘ëª©ì„ ìƒë‹¹ ë¶€ë¶„ í•´ì†Œí•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
- ìœ ì € ìš”ì²­ â†’ Redis ëŒ€ê¸°ì—´ â†’ ìŠ¤ì¼€ì¤„ ë°œê¸‰ â†’ DB ì €ì¥ì˜ ì•ˆì •ì ì¸ íŒŒì´í”„ë¼ì¸ êµ¬ì„±
- ì¸ê¸° ìƒí’ˆ ì¡°íšŒì˜ ì‹¤ì‹œê°„ì„± ë° ì •ë ¬ ì‘ë‹µ ê°œì„ 

í•˜ì§€ë§Œ Redisë¥¼ ë‹¨ì¼ ì˜ì¡´ ìš”ì†Œë¡œ ë‘ê³  ìˆëŠ” êµ¬ì¡°ì  íŠ¹ì„±ìƒ, ë‹¤ìŒê³¼ ê°™ì€ ë³´ì™„ ê³¼ì œê°€ ì—¬ì „íˆ ì¡´ì¬í•©ë‹ˆë‹¤:
- Redis ì¥ì•  ì‹œ ì „ì²´ ê¸°ëŠ¥ ë§ˆë¹„ ìœ„í—˜ â†’ ì´ì¤‘í™” ë° fallback ì „ëµ í•„ìš”
- ë©”ëª¨ë¦¬ ê¸°ë°˜ ì‹œìŠ¤í…œì˜ íœ˜ë°œì„±ê³¼ ì¥ì•  ë³µêµ¬ í›„ ì •í•©ì„± ë³´ì¥ ë¬¸ì œ
- íŠ¸ë˜í”½ ê¸‰ì¦ ì‹œ Redis ë¶€í•˜ ë¶„ì‚° ì „ëµ ë¶€ì¡±

ë”°ë¼ì„œ ì„±ëŠ¥ ê°œì„ ì´ë¼ëŠ” 1ì°¨ ëª©í‘œëŠ” ë‹¬ì„±í–ˆì§€ë§Œ, ì¥ê¸°ì ìœ¼ë¡œëŠ” ì•ˆì •ì„±ê³¼ ë³µêµ¬ ê°€ëŠ¥ì„±ì„ í•¨ê»˜ ê³ ë ¤í•œ ê³ ë„í™”ê°€ ì¶”ê°€ë¡œ í•„ìš”í•´ë³´ì…ë‹ˆë‹¤.