# ⚠️ 가상 장애 대응 보고서 – 선착순 쿠폰 발급 이벤트
## 🆘 장애 개요
- `장애명`: TPS 미달에 따른 쿠폰 발급 응답 지연 및 처리 누락
- `발생 일시`: 2025-06-05 10:00 (이벤트 시작 시각)
- `영향 범위`: 이벤트 참가자 약 5만 명 중 80% 이상 쿠폰 발급 실패
- `장애 유형`: 시스템 처리량 부족 / 발급 성공률 급감 / UX 저하

## ❗️ 장애 발생 배경
- 부하 테스트 당시 평균 TPS 164로 측정됨 (목표 400 TPS 미달)
- max_count 제한으로 인해 조기 발급 차단 발생
- Kafka partition 수 1개로 Consumer 병렬 처리 불가
- 스크립트가 RPS 기반이 아닌 VU 기반 → 피크 시점에서도 요청 생성량 한계
> → 이를 개선하지 않은 채 실 서비스에 적용함

## 🧨 장애 현상
- `사용자 현상`: 발급 요청이 "바로 실패", 일부는 5초 이상 응답 지연 발생
- `시스템 로그`: 중복 발급 차단 로그 급증, Kafka 소비는 지속되나 처리 TPS 저조
- `발급 결과`: 총 요청 `50,000건` 중 실제 발급 `9,928건` → `성공률 약 20%`
- `사용자 불만`: `“버튼 눌렀는데 반응 없음”`, `“서버 터짐?”`, `“왜 발급 안 돼요?”` 등 제기

## 📊 근본 원인 분석 (RCA)
- 처리 TPS 미달: VU 기반 테스트 방식과 sleep 구조가 TPS 증가를 제한
- 발급 로직 병목: 쿠폰 수량 제한 도달 후에도 요청 계속됨 → 낭비 처리
- Kafka 병렬성 미흡: partition 수 부족으로 Consumer 확장 불가
- 응답 속도는 빠르나 처리량 부족: 시스템은 정상 응답하지만 발급 수는 낮음

## 🛠 장애 대응 조치
- `10:05`: 사용자 응답 실패율 급증 확인 후 Slack 알림 트리거
- `10:07`: Kafka lag 0 확인 → 발급 로직 문제로 원인 좁힘
- `10:10`: DB 쿠폰 발급 성공 수 9928로 확인 → 수량 제한 원인 확인
- `10:12`: 이벤트 페이지 공지 배포 ("조기 마감")
- `10:30`: 긴급 회의 후 max_count 3만으로 재오픈 결정

## 🔁 후속 조치
- `부하 테스트 개선`: constant-arrival-rate 기반 RPS 목표 시나리오 설계
- `Kafka 병렬성 향상`: partition 수 3개 이상으로 증설, consumer group 구성
- `TPS 모니터링 추가`: Prometheus에 처리 TPS 직접 노출 (Micrometer counter)
- `발급 성공률 기준 개선`: 전체 요청이 아닌 "발급 대상자 기준" 성공률로 정의 변경
- `발급 로직 비동기화`: 요청 응답 후 Kafka 발급 처리로 전환, 발급 결과는 별도 조회