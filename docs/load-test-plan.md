# 부하 테스트 계획 및 결과 보고서
## 쿠폰 발급 요청
### 📌 개요
쿠폰 발급 요청은 선착순 쿠폰 이벤트 오픈 시 다수 사용자가 동시에 쿠폰을 요청하는 상황에서 시스템의 처리 성능, 병목 지점, 안정성을 `Peak test`로 검증하고자 합니다.
> 💡 선착순 쿠폰 이벤트는 특정 시점에 대량의 사용자가 동시에 몰리는 피크 트래픽 특성을 가집니다.<br>
> 이러한 상황에서는 일반적인 부하가 아닌, 짧은 시간 동안 폭발적인 요청량이 집중되는 극한 조건에 대한 시스템의 대응 능력을 검증하는 것이 중요합니다.<br>
> 따라서, **최대 동시 요청이 몰릴 수 있는 시점의 순간 처리 능력(Throughput, Latency, 안정성)**을 확인하기 위해 `Peak Test`를 선택하였습니다.

### 🔧 테스트 도구 및 환경
- 부하 생성기: `k6`
- spring 앱 실행 환경: `cpus: 4` `mem_limit: 4g` `JAVA_OPTS: -Xms2g -Xmx3g -XX:+UseG1GC -XX:MaxGCPauseMillis=200`

### 🚙 테스트 시나리오
- 테스트 유형: `Peak Test`
- 대상 API: `POST - /coupon/issue`
- 목표 동시 사용자 수: `최대 500 VU`
- 총 테스트 시간: `5분`
- 시나리오 단계:
```javascript
stages: [
  { duration: '1m', target: 10 },
  { duration: '30s', target: 100 },
  { duration: '2m', target: 500 },
  { duration: '30s', target: 100 },
  { duration: '1m', target: 0 },
]
```
- 예상 발급 건수: `약 5만건`
- 요청: 각 VU는 초당 1건 요청(`sleep(1)`적용 기준)
```javascript
{
  "userId": Math.floor(Math.random() * 10000),
  "couponId": 2
}
```

### 🎯 목표
> "최대 2000명 동시 요청 상황에서 쿠폰 발급 요청 API가 안정적으로 처리 가능한가?"<br>
> "해당 TPS에서도 응답 시간이 사용자 경험에 문제 없는 수준인가?"
- 요청 처리 TPS: `≥ 400 TPS`
- `P90`, `P95` 응답 시간: `≤ 1000ms`

## 쿠폰 발급 처리
### 📌 개요
쿠폰 발급 처리는 앞선 쿠폰 발급 요청 테스트에서 모니터링된 TPS와 요청량을 기준으로, 실제로 쿠폰이 정상적으로 발급 처리되었는지를 확인하고자 합니다.
> 💡 쿠폰 발급 처리는 Kafka를 통해 비동기 이벤트로 발행되며, 해당 이벤트를 `Kafka Consumer`가 수신하여 실제 쿠폰 발급 로직을 처리합니다<br>
> 이 과정이 지연되거나 병목이 발생하면 사용자에게 늦게 발급되거나 발급이 누락되는 현상이 발생할 수 있습니다.<br>
> 따라서, 쿠폰 발급 요청 후 실제 발급 완료까지의 **처리 속도(TPS)**와 `Kafka Lag`을 기준으로 처리 안정성을 검증하고자 합니다.

### 🔧 테스트 도구 및 환경
- 메시지 큐: `Kafka`
- 소비자 처리: `Spring Kafka Consumer`
- Kafka 관측 도구: `Kafka UI`
- 내부 지표 수집: `Spring Actuator`, `Prometheus`

### 📈 측정 항목
- 처리 TPS: 초당 실제 발급 처리 수
- Kafka Lag: 	처리되지 않고 남은 메시지 수
- 처리 성공률: 	Kafka 메시지 수신 대비 DB 발급 성공 비율
- 지연 시간: 발급 요청 → 발급 완료까지 걸린 시간

### 🎯 목표
> "최대 요청 트래픽이 유입되더라도, 발급 처리 TPS가 충분하고 Kafka 메시지 누락이나 병목 없이 안정적으로 처리되는가?"
- 발급 처리 TPS: `≥ 350 TPS`
- Kafka Lag: `≤ 100`
- 발급 성공률: `100%`
- `P90`, `P95` 처리 시간: `≤ 1000ms`